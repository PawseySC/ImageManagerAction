name: Reusable â€” PUSH PRIVATE

on:
  workflow_call:
    inputs:
      runner_label:
        required: true
        type: string
      main:
        required: true
        type: string
      feature:
        required: true
        type: string
      version:
        required: true
        type: string
      has_template:
        required: true
        type: string
      build_matrix:
        required: true
        type: string
      private_targets:
        required: true
        type: string
      setonixreg_available:
        required: true
        type: string
    secrets:
      ACACIA_ACCESS_KEY_ID:
        required: true
      ACACIA_SECRET_ACCESS_KEY:
        required: true
      SETONIXREG_PASS:
        required: false

jobs:
  push_private:
    runs-on: ${{ inputs.runner_label }}
    strategy:
      matrix: ${{ fromJson(inputs.build_matrix) }}
      fail-fast: false
    env:
      VERSION: ${{ inputs.version }}
      BUCKET: ${{ vars.ACACIA_BUCKETNAME }}
    steps:
    - name: Compute image name for this variant
      id: compute_image_name
      run: |
        set -euo pipefail

        # Get template values from matrix
        template_values='${{ toJson(matrix.values) }}'
        main="${{ inputs.main }}"
        feature="${{ inputs.feature }}"

        # Compute variant suffix (same logic as BUILD job)
        if [ "${{ inputs.has_template }}" = "true" ] && [ "$template_values" != "{}" ]; then
          variant_suffix=$(echo "$template_values" | jq -r 'to_entries | map("-" + .key + "-" + .value) | join("")' | tr '[:upper:]' '[:lower:]')
        else
          variant_suffix=""
        fi

        # Sanitize image name (same logic as BUILD job)
        image_name_raw="${main}-${feature}${variant_suffix}"
        image_name=$(echo "$image_name_raw" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9._-]/-/g' | sed 's/-\+/-/g' | sed 's/^[.-]*//;s/[.-]*$//')

        echo "IMAGE_NAME=$image_name" >> $GITHUB_ENV
        echo "Computed image name: $image_name"

    - name: Display registry environment
      run: |
        echo "Hostname: $(hostname)"
        echo "Pushing: ${IMAGE_NAME}:${VERSION}"
        echo "Variant #${{ matrix.index }}"

    - name: Configure podman environment
      run: |
        echo "Setting up container environment variables for push..."

        # Export environment variables (same as BUILD-job)
        export XDG_DATA_HOME=/container/${USER}/data
        export XDG_RUNTIME_DIR=/container/${USER}/runtime
        export TMPDIR=/container/${USER}/tmp/

        # Create required directories
        mkdir -p ${XDG_DATA_HOME}
        mkdir -p ${XDG_RUNTIME_DIR}
        mkdir -p ${TMPDIR}

        echo "Push environment setup completed:"
        echo "XDG_DATA_HOME: ${XDG_DATA_HOME}"
        echo "XDG_RUNTIME_DIR: ${XDG_RUNTIME_DIR}"
        echo "TMPDIR: ${TMPDIR}"

        # Set environment variables for subsequent steps
        echo "XDG_DATA_HOME=${XDG_DATA_HOME}" >> $GITHUB_ENV
        echo "XDG_RUNTIME_DIR=${XDG_RUNTIME_DIR}" >> $GITHUB_ENV
        echo "TMPDIR=${TMPDIR}" >> $GITHUB_ENV

    - name: Download archive from S3
      id: locate_archive
      uses: ./.github/actions/setup-rclone
      with:
        access_key_id: ${{ secrets.ACACIA_ACCESS_KEY_ID }}
        secret_access_key: ${{ secrets.ACACIA_SECRET_ACCESS_KEY }}
        endpoint: https://projects.pawsey.org.au
        bucket: ${{ env.BUCKET }}
        destination_path: ${{ env.IMAGE_NAME }}_${{ env.VERSION }}.tar
        download_mode: true
        dockerfile_name: ${{ env.IMAGE_NAME }}
        version: ${{ env.VERSION }}
        load_to_podman: false

    - name: Push to Setonix private registry
      if: inputs.setonixreg_available == 'true'
      continue-on-error: true
      run: |
        set +e  # Don't exit on errors to allow independent execution
        echo "=========================================="
        echo " Setonix Registry Push Process"
        echo "=========================================="

        # Load image from archive first
        echo "ðŸ“¦ Loading image from archive..."
        archive_file="${{ steps.locate_archive.outputs.archive_name }}"
        if podman load -i "$archive_file"; then
          echo "âœ“ Image loaded successfully from archive"
        else
          echo "âœ— Failed to load image from archive"
          exit 1
        fi

        # Login to Setonix Registry
        echo "ðŸ” Logging into Setonix Registry..."
        if podman login https://setonix-registry.pawsey.org.au -u "${{ vars.SETONIXREG_USERNAME }}" -p "${{ secrets.SETONIXREG_PASS }}"; then
          echo "âœ“ Setonix Registry login successful"
        else
          echo "âœ— Setonix Registry login failed"
          exit 1
        fi

        # Get private targets from manifest and use the first one as username
        private_targets='${{ inputs.private_targets }}'
        private_username=$(echo "$private_targets" | jq -r '.[0] // empty')

        if [ -z "$private_username" ] || [ "$private_username" = "null" ]; then
          echo "Error: No private targets found in manifest"
          exit 1
        fi

        # Tag and push (IMAGE_NAME already includes variant suffix from BUILD-job)
        image_tag="${IMAGE_NAME}:${VERSION}"
        setonix_tag="setonix-registry.pawsey.org.au/${private_username}/${IMAGE_NAME}:${VERSION}"

        echo ""
        echo "ðŸ·ï¸  Tagging image for Setonix Registry:"
        echo "   Source: $image_tag"
        echo "   Target: $setonix_tag"

        if podman tag "$image_tag" "$setonix_tag"; then
          echo "âœ“ Image tagged successfully"
        else
          echo "âœ— Image tagging failed"
          exit 1
        fi

        echo ""
        echo "ðŸ“¤ Pushing to Setonix Registry..."
        if podman push "$setonix_tag"; then
          echo "âœ… Successfully pushed to Setonix Registry: $setonix_tag"
        else
          echo "âŒ Failed to push to Setonix Registry"
          exit 1
        fi

        # Cleanup local tagged image
        echo ""
        echo "ðŸ§¹ Cleaning up local Setonix tagged image..."
        podman rmi "$setonix_tag" 2>/dev/null || echo "  (Setonix tag already removed or not found)"
        podman rmi "$image_tag" 2>/dev/null || echo "  (Base image already removed or not found)"
